<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½’å¹¶æ’åºå¯è§†åŒ– | Merge Sort Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #4f46e5;
            --secondary: #8b5cf6;
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            /* å½’å¹¶æ’åºç‰¹æœ‰å˜é‡ */
            --block-size: 48px;
            --level-height: 100px;
            --gap-x: 12px;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-gradient);
            color: #334155;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ç»ç’ƒæ‹Ÿæ€æ•ˆæœ */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        /* å½’å¹¶æ’åºèˆå° */
        .viz-stage {
            position: relative;
            width: 100%;
            height: 520px; /* è¶³å¤Ÿå®¹çº³é€’å½’å±‚çº§ */
            overflow: hidden; /* éšè—æº¢å‡ºï¼Œæˆ–è€…æ”¹ä¸º visible è§†æƒ…å†µè€Œå®š */
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
            border-radius: 1rem;
            transition: height 0.3s ease;
        }

        /* æ•°ç»„æ–¹å—å…ƒç´  */
        .array-item {
            position: absolute;
            width: var(--block-size);
            height: var(--block-size);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 800;
            font-size: 16px;
            background-color: white;
            border: 2px solid #cbd5e1;
            color: #475569;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: top 0.5s cubic-bezier(0.25, 1, 0.5, 1), 
                        left 0.5s cubic-bezier(0.25, 1, 0.5, 1),
                        transform 0.3s, background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
            z-index: 10;
            will-change: top, left;
        }

        /* è¿çº¿æ•ˆæœ (ä¼ªå…ƒç´ ) */
        .array-item::before {
            content: '';
            position: absolute;
            top: -40px;
            left: 50%;
            width: 2px;
            height: 40px;
            background: #e2e8f0;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
        }
        .item-deep .array-item::before { opacity: 1; }

        /* çŠ¶æ€é¢œè‰²ç³»ç»Ÿ */
        .color-default { background-color: white; border-color: #cbd5e1; }
        
        /* å·¦åŒºé—´ L */
        .color-left { 
            background-color: #eff6ff !important; 
            border-color: #3b82f6 !important; 
            color: #1d4ed8 !important; 
        }
        
        /* å³åŒºé—´ R */
        .color-right { 
            background-color: #fdf4ff !important; 
            border-color: #d946ef !important; 
            color: #a21caf !important; 
        }

        /* æ¯”è¾ƒä¸­/é«˜äº® */
        .color-comparing { 
            transform: scale(1.15);
            z-index: 50; 
            border-color: #f59e0b !important; /* Amber */
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3) !important;
        }

        /* å·²å½’å¹¶/æ’åºå®Œæˆ */
        .color-sorted { 
            background-color: #ecfdf5 !important; 
            border-color: #10b981 !important; 
            color: #047857 !important; 
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2) !important;
        }

        /* æŒ‡é’ˆç³»ç»Ÿ (ä¿ç•™é€‰æ‹©æ’åºé£æ ¼çš„Tag) */
        .pointer-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            overflow: visible;
        }

        .pointer {
            position: absolute;
            transition: top 0.5s cubic-bezier(0.25, 1, 0.5, 1), left 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 40;
            width: 40px;
            height: 50px;
        }

        .pointer-tag {
            font-size: 10px;
            font-weight: 800;
            padding: 3px 6px;
            border-radius: 4px;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 2px;
            text-transform: uppercase;
        }

        .pointer-arrow {
            width: 0; 
            height: 0; 
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 6px solid; /* å‘ä¸Šç®­å¤´ */
        }

        /* L æŒ‡é’ˆ (Blue) */
        .pointer-l .pointer-tag { background-color: #3b82f6; }
        .pointer-l .pointer-arrow { border-bottom-color: #3b82f6; }
        
        /* R æŒ‡é’ˆ (Fuchsia) */
        .pointer-r .pointer-tag { background-color: #d946ef; }
        .pointer-r .pointer-arrow { border-bottom-color: #d946ef; }

        /* ç»ˆç«¯æ—¥å¿— */
        .log-container {
            font-family: 'JetBrains Mono', monospace;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #4f46e5;
        }
        .log-entry { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: 0; } }

        /* å¸ƒå±€æ§åˆ¶ */
        .layout-default .main-grid { display: flex; flex-direction: column; gap: 1.5rem; }
        .layout-sidebar .main-grid { display: grid; grid-template-columns: 1fr 350px; gap: 1.5rem; }
        @media (max-width: 1024px) { .layout-sidebar .main-grid { grid-template-columns: 1fr; } }

        /* çŠ¶æ€ç¯ */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .dot-running { background: #10b981; animation: pulse 1.5s infinite; }
        .dot-paused { background: #f59e0b; }
        .dot-idle { background: #94a3b8; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }

        /* å¾½ç«  */
        .badge { display: inline-flex; align-items: center; padding: 0.125rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; }
        .badge-worst { background-color: #fee2e2; color: #991b1b; }
        .badge-stable { background-color: #d1fae5; color: #065f46; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <div class="flex items-center gap-3 mb-1">
                    <div class="p-2 bg-indigo-600 rounded-xl text-white shadow-lg shadow-indigo-200 transform -rotate-3">
                        <i class="fas fa-layer-group fa-lg"></i>
                    </div>
                    <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">å½’å¹¶æ’åº</h1>
                </div>
                <p class="text-slate-500 font-medium">Visualization of Merge Sort Algorithm</p>
            </div>
            <div class="flex gap-3">
                <button id="layoutToggle" class="glass-card px-5 py-2.5 rounded-xl text-slate-700 font-semibold hover:bg-white transition flex items-center gap-2">
                    <i class="fas fa-columns text-indigo-500"></i> è§†å›¾åˆ‡æ¢
                </button>
            </div>
        </header>

        <div id="mainContent" class="layout-default">
            
            <!-- Control Panel -->
            <section class="glass-card rounded-2xl p-6 mb-6">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 items-end">
                    <!-- Size Control -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">æ•°ç»„è§„æ¨¡</label>
                            <span id="sizeValue" class="text-indigo-600 font-bold font-mono text-sm">8</span>
                        </div>
                        <input type="range" id="sizeSlider" min="4" max="16" value="8" class="w-full accent-indigo-600 cursor-pointer h-2 bg-slate-200 rounded-lg appearance-none">
                    </div>
                    
                    <!-- Speed Control -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">åŠ¨ç”»é€Ÿåº¦</label>
                            <span id="speedValue" class="text-indigo-600 font-bold font-mono text-sm">3</span>
                        </div>
                        <input type="range" id="speedSlider" min="1" max="5" value="3" class="w-full accent-indigo-600 cursor-pointer h-2 bg-slate-200 rounded-lg appearance-none">
                    </div>

                    <!-- Custom Input -->
                    <div class="lg:col-span-1">
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-2">è‡ªå®šä¹‰æ•°æ®</label>
                        <input type="text" id="customArray" placeholder="ä¾‹å¦‚: 8,3,5,4" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition shadow-sm font-mono">
                    </div>

                    <!-- Generate Button -->
                    <button id="generateBtn" class="bg-indigo-50 text-indigo-600 h-10 px-4 rounded-xl font-bold hover:bg-indigo-100 transition border border-indigo-100 flex items-center justify-center gap-2">
                        <i class="fas fa-sync-alt"></i> ç”Ÿæˆæ•°ç»„
                    </button>
                </div>
            </section>

            <div class="main-grid">
                <!-- Left/Top Section: Visualization -->
                <div class="space-y-6">
                    <section class="glass-card rounded-3xl p-6 relative flex flex-col">
                        <!-- Status Bar -->
                        <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-100 z-20">
                            <div class="flex items-center gap-4">
                                <span class="flex items-center text-sm font-bold text-slate-600 bg-white border border-slate-200 px-4 py-1.5 rounded-full shadow-sm">
                                    <span id="statusIndicator" class="status-dot dot-idle"></span>
                                    <span id="statusText">å‡†å¤‡å°±ç»ª</span>
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-400 font-bold uppercase">Comparisons</span>
                                <div id="compCount" class="font-mono text-xl font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg border border-indigo-100">
                                    0
                                </div>
                            </div>
                        </div>

                        <!-- Visualization Container (Stage) -->
                        <div id="vizStage" class="viz-stage mb-6">
                            <!-- JS Generated Items -->
                            <div id="pointerLayer" class="pointer-container">
                                <!-- JS Generated Pointers -->
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="flex flex-wrap justify-center gap-3 z-20">
                            <button id="startBtn" class="group px-6 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 active:scale-95 flex items-center gap-2">
                                <i class="fas fa-play"></i> å¼€å§‹å½’å¹¶
                            </button>
                            <button id="pauseBtn" disabled class="px-6 py-2.5 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                <i class="fas fa-pause"></i> æš‚åœ
                            </button>
                            <button id="stepBtn" disabled class="px-6 py-2.5 bg-white border border-slate-200 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 transition disabled:opacity-50 active:scale-95 flex items-center gap-2">
                                <i class="fas fa-step-forward"></i> å•æ­¥
                            </button>
                            <button id="resetBtn" class="px-6 py-2.5 bg-rose-50 border border-rose-100 text-rose-600 rounded-xl font-bold hover:bg-rose-100 transition active:scale-95 flex items-center gap-2">
                                <i class="fas fa-undo"></i> é‡ç½®
                            </button>
                        </div>
                    </section>

                    <!-- Terminal Log -->
                    <section class="log-container rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-3 border-b border-slate-200 pb-2">
                            <div class="flex items-center gap-2 text-slate-700 text-xs font-bold uppercase tracking-widest">
                                <i class="fas fa-terminal text-indigo-500"></i> æ‰§è¡Œæ—¥å¿—
                            </div>
                            <button onclick="clearLog()" class="text-slate-400 hover:text-slate-600 text-xs"><i class="fas fa-trash"></i></button>
                        </div>
                        <div id="terminalLog" class="h-32 overflow-y-auto space-y-1.5 text-sm scrollbar-hide px-1">
                            <div class="text-slate-500 flex items-start gap-2">
                                <span class="text-indigo-400 font-bold">></span> 
                                <span>ç­‰å¾…ç³»ç»ŸæŒ‡ä»¤...</span>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Right/Bottom Section: Algorithm Info -->
                <aside id="infoSection" class="glass-card rounded-2xl p-6 border-t-4 border-indigo-500 h-full">
                    <div id="introContent">
                        <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fas fa-book-open text-indigo-500"></i> ç®—æ³•è¯¦è§£
                        </h3>
                        
                        <!-- Legend -->
                        <div class="mb-6 bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">å›¾ä¾‹è¯´æ˜</h4>
                            <div class="grid grid-cols-2 gap-3 text-xs font-medium text-slate-600">
                                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-blue-100 border border-blue-500"></div>å·¦åŒºé—´ (L)</div>
                                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-fuchsia-100 border border-fuchsia-500"></div>å³åŒºé—´ (R)</div>
                                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-white border border-amber-500 shadow-sm"></div>æ¯”è¾ƒä¸­</div>
                                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-emerald-100 border border-emerald-500"></div>å·²å½’å¹¶</div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-slate-200 flex gap-4 text-xs">
                                <div class="flex items-center gap-1"><span class="bg-blue-500 text-white px-1.5 rounded">L</span> å·¦æŒ‡é’ˆ</div>
                                <div class="flex items-center gap-1"><span class="bg-fuchsia-500 text-white px-1.5 rounded">R</span> å³æŒ‡é’ˆ</div>
                            </div>
                        </div>

                        <!-- Algorithm Details -->
                        <div class="space-y-6 text-slate-600 text-sm">
                            <div>
                                <h4 class="font-bold text-slate-800 mb-2">ğŸ’¡ æ ¸å¿ƒæ€æƒ³</h4>
                                <p class="leading-relaxed">åˆ†æ²»æ³• (Divide and Conquer)ã€‚å°†æ•°ç»„ä¸æ–­äºŒåˆ†ç›´åˆ°åªå‰©ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åä¸¤ä¸¤åˆå¹¶(Merge)æœ‰åºåºåˆ—ï¼Œæœ€ç»ˆå¾—åˆ°æœ‰åºæ•°ç»„ã€‚</p>
                            </div>

                            <div>
                                <h4 class="font-bold text-slate-800 mb-2">ğŸ“Š å¤æ‚åº¦åˆ†æ</h4>
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <span class="badge badge-worst">æ—¶é—´: O(n log n)</span>
                                    <span class="badge badge-worst">ç©ºé—´: O(n)</span>
                                </div>
                                <p class="text-xs text-slate-500">æ•ˆç‡éå¸¸ç¨³å®šï¼Œä½†éœ€è¦é¢å¤–çš„ O(n) ç©ºé—´ã€‚</p>
                            </div>

                            <div>
                                <h4 class="font-bold text-slate-800 mb-2">âš–ï¸ ç¨³å®šæ€§</h4>
                                <span class="badge badge-stable mb-1">ç¨³å®š</span>
                                <p class="text-xs text-slate-500 mt-1">ç›¸åŒå€¼çš„å…ƒç´ åœ¨æ’åºåç›¸å¯¹ä½ç½®ä¸å˜ã€‚</p>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-8 text-center text-slate-400 text-xs pb-4">
            <p>Designed with Tailwind CSS & Glassmorphism</p>
        </footer>
    </div>

    <script>
        // --- å…¨å±€é…ç½®ä¸çŠ¶æ€ ---
        const config = {
            blockSize: 48,
            gapX: 12,
            levelHeight: 100,
            baseTop: 60,
            speeds: [2000, 1200, 800, 400, 150]
        };

        let state = {
            visualItems: [],    // å­˜å‚¨ {id, value, el, currentIdx, depth}
            arraySize: 8,
            speed: 800,
            isSorting: false,
            isPaused: false,
            isComplete: false,
            stopFlag: false,
            stepResolver: null,
            comparisons: 0,
            savedInitialData: [],
            currentPointers: { l: null, r: null }
        };

        // --- DOM å…ƒç´  ---
        const els = {
            sizeSlider: document.getElementById('sizeSlider'),
            sizeValue: document.getElementById('sizeValue'),
            speedSlider: document.getElementById('speedSlider'),
            speedValue: document.getElementById('speedValue'),
            customInput: document.getElementById('customArray'),
            genBtn: document.getElementById('generateBtn'),
            startBtn: document.getElementById('startBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            stepBtn: document.getElementById('stepBtn'),
            resetBtn: document.getElementById('resetBtn'),
            stage: document.getElementById('vizStage'),
            pointerLayer: document.getElementById('pointerLayer'),
            log: document.getElementById('terminalLog'),
            statusText: document.getElementById('statusText'),
            statusDot: document.getElementById('statusIndicator'),
            compCount: document.getElementById('compCount'),
            layoutToggle: document.getElementById('layoutToggle'),
            mainContent: document.getElementById('mainContent')
        };

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            generateArray(true);
            setupResizeObserver();
        });

        function initEventListeners() {
            // å¸ƒå±€åˆ‡æ¢
            els.layoutToggle.addEventListener('click', toggleLayout);

            // æ»‘å—æ§åˆ¶
            els.sizeSlider.addEventListener('input', e => {
                els.sizeValue.textContent = e.target.value;
                state.arraySize = parseInt(e.target.value);
                if (!state.isSorting) generateArray(true);
            });

            els.speedSlider.addEventListener('input', e => {
                els.speedValue.textContent = e.target.value;
                state.speed = config.speeds[e.target.value - 1];
            });

            // æŒ‰é’®æ§åˆ¶
            els.genBtn.addEventListener('click', () => {
                const val = els.customInput.value.trim();
                if(val) {
                    const arr = val.split(/[,ï¼Œ ]+/).map(Number).filter(n => !isNaN(n));
                    if(arr.length > 1 && arr.length <= 16) {
                        state.arraySize = arr.length;
                        els.sizeSlider.value = arr.length;
                        els.sizeValue.textContent = arr.length;
                        createVisualItems(arr);
                        state.savedInitialData = [...arr];
                        resetState();
                    } else {
                        alert('è¯·è¾“å…¥2-16ä¸ªæ•°å­—ï¼Œç”¨é€—å·åˆ†éš”');
                    }
                } else {
                    generateArray(true);
                }
            });

            els.startBtn.addEventListener('click', () => {
                if (state.isPaused && state.isSorting) togglePause();
                else startSort();
            });
            els.pauseBtn.addEventListener('click', togglePause);
            els.stepBtn.addEventListener('click', stepExec);
            els.resetBtn.addEventListener('click', () => hardReset(false));
        }

        // --- è§†å›¾ä¸å¸ƒå±€ ---
        function toggleLayout() {
            const isDefault = els.mainContent.classList.contains('layout-default');
            if (isDefault) {
                els.mainContent.classList.remove('layout-default');
                els.mainContent.classList.add('layout-sidebar');
                els.layoutToggle.innerHTML = '<i class="fas fa-arrow-up text-indigo-500"></i> é»˜è®¤è§†å›¾';
            } else {
                els.mainContent.classList.remove('layout-sidebar');
                els.mainContent.classList.add('layout-default');
                els.layoutToggle.innerHTML = '<i class="fas fa-columns text-indigo-500"></i> ä¾§è¾¹è§†å›¾';
            }
            setTimeout(recalculatePositions, 300);
        }

        function setupResizeObserver() {
            new ResizeObserver(() => {
                if (state.visualItems.length > 0) requestAnimationFrame(recalculatePositions);
            }).observe(els.stage);
        }

        function recalculatePositions() {
            state.visualItems.forEach(item => {
                const coords = getCoordinates(item.currentIdx, item.depth);
                item.el.style.left = `${coords.left}px`;
                item.el.style.top = `${coords.top}px`;
            });
            // é‡æ–°å®šä½æŒ‡é’ˆ
            if (state.currentPointers.l && state.currentPointers.r) {
                showPointers(state.currentPointers.l, state.currentPointers.r, false);
            }
        }

        function getCoordinates(index, depth) {
            const totalItems = state.visualItems.length;
            const stageWidth = els.stage.clientWidth || 800;
            const contentWidth = totalItems * (config.blockSize + config.gapX) - config.gapX;
            // å±…ä¸­è®¡ç®—
            const startX = Math.max(20, (stageWidth - contentWidth) / 2);
            
            return {
                left: startX + index * (config.blockSize + config.gapX),
                top: config.baseTop + depth * config.levelHeight
            };
        }

        // --- æ•°æ®ç”Ÿæˆä¸æ¸²æŸ“ ---
        function generateArray(isNew = true) {
            if (isNew) {
                const arr = Array.from({length: state.arraySize}, () => Math.floor(Math.random() * 90) + 10);
                state.savedInitialData = [...arr];
                createVisualItems(arr);
            } else {
                createVisualItems(state.savedInitialData);
            }
            resetState();
        }

        function createVisualItems(arr) {
            // æ¸…ç†
            const items = els.stage.querySelectorAll('.array-item');
            items.forEach(el => el.remove());
            els.pointerLayer.innerHTML = '';
            
            state.visualItems = [];
            state.currentPointers = { l: null, r: null };

            arr.forEach((val, idx) => {
                const el = document.createElement('div');
                el.className = 'array-item color-default';
                el.textContent = val;
                els.stage.appendChild(el);
                
                state.visualItems.push({
                    id: idx,
                    value: val,
                    el: el,
                    currentIdx: idx,
                    depth: 0
                });
            });
            recalculatePositions();
        }

        function resetState() {
            state.isSorting = false;
            state.isPaused = false;
            state.isComplete = false;
            state.stopFlag = false;
            state.stepResolver = null;
            state.comparisons = 0;
            
            els.compCount.textContent = '0';
            updateStatus('å‡†å¤‡å°±ç»ª', 'idle');
            els.log.innerHTML = '<div class="text-slate-500 flex items-start gap-2"><span class="text-indigo-400 font-bold">></span><span>ç³»ç»Ÿé‡ç½®å°±ç»ª</span></div>';
            
            els.startBtn.disabled = false;
            els.startBtn.innerHTML = '<i class="fas fa-play"></i> å¼€å§‹å½’å¹¶';
            els.pauseBtn.disabled = true;
            els.stepBtn.disabled = true;
            els.pointerLayer.innerHTML = '';
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---

        async function startSort() {
            if (state.isSorting) return;
            if (state.isComplete) generateArray(false);

            state.isSorting = true;
            state.stopFlag = false;
            updateStatus('å½’å¹¶ä¸­', 'running');
            
            els.startBtn.disabled = true;
            els.pauseBtn.disabled = false;
            els.stepBtn.disabled = false;
            els.resetBtn.disabled = false;
            
            log('ğŸš€ å½’å¹¶æ’åºå¼€å§‹');
            
            try {
                await mergeSort(0, state.visualItems.length - 1, 1);
                finishSort();
            } catch (e) {
                if (e.message !== 'ABORT') console.error(e);
                updateStatus('å·²åœæ­¢', 'paused');
            }
        }

        async function mergeSort(l, r, depth) {
            if (l >= r || state.stopFlag) return;

            const m = Math.floor((l + r) / 2);

            // æ‹†åˆ†è¿‡ç¨‹ï¼šä¸‹æ²‰
            log(`ğŸ”½ æ‹†åˆ†åŒºé—´ [${l}, ${r}] åˆ°æ·±åº¦ ${depth}`);
            for (let i = l; i <= r; i++) {
                moveItem(state.visualItems[i], i, depth);
            }
            
            // æŸ“è‰²è¡¨ç¤ºå·¦å³åˆ†æ”¯
            setRangeColor(l, m, 'color-left');
            setRangeColor(m + 1, r, 'color-right');
            
            await waitStep();

            await mergeSort(l, m, depth + 1);
            await mergeSort(m + 1, r, depth + 1);

            // åˆå¹¶è¿‡ç¨‹
            await merge(l, m, r, depth - 1);
        }

        async function merge(l, m, r, targetDepth) {
            if (state.stopFlag) throw new Error('ABORT');
            
            log(`ğŸ”„ åˆå¹¶åŒºé—´: [${l}-${m}] å’Œ [${m+1}-${r}]`);
            
            const temp = [];
            let i = l, j = m + 1;
            
            // åˆ›å»ºå¿«ç…§ä»¥ä¾¿åœ¨åŠ¨ç”»ç§»åŠ¨æ—¶å¼•ç”¨æ­£ç¡®çš„å¯¹è±¡
            const currentSnapshot = [...state.visualItems];

            while (i <= m && j <= r) {
                if (state.stopFlag) throw new Error('ABORT');
                state.comparisons++;
                els.compCount.textContent = state.comparisons;

                const itemL = currentSnapshot[i];
                const itemR = currentSnapshot[j];

                // æ˜¾ç¤ºæŒ‡é’ˆå’Œé«˜äº®
                showPointers(itemL, itemR);
                itemL.el.classList.add('color-comparing');
                itemR.el.classList.add('color-comparing');
                
                await waitStep();

                let winner;
                if (itemL.value <= itemR.value) {
                    log(`  ğŸ‘ˆ å·¦è¾¹å°: ${itemL.value} <= ${itemR.value}`);
                    winner = itemL;
                    i++;
                } else {
                    log(`  ğŸ‘‰ å³è¾¹å°: ${itemR.value} < ${itemL.value}`);
                    winner = itemR;
                    j++;
                }

                // ç§»é™¤é«˜äº®ï¼Œè®¾ç½®ä¸ºæœ‰åºè‰²
                itemL.el.classList.remove('color-comparing');
                itemR.el.classList.remove('color-comparing');
                winner.el.className = 'array-item color-sorted';

                // ç§»åŠ¨åˆ°ä¸Šä¸€å±‚çš„æ–°ä½ç½®
                const targetIdx = l + temp.length;
                moveItem(winner, targetIdx, targetDepth);
                temp.push(winner);
                
                await waitStep(0.6); // ç¨å¾®å¿«ä¸€ç‚¹ç§»åŠ¨
            }

            // å¤„ç†å‰©ä½™å…ƒç´ 
            const processRemaining = async (idx) => {
                if(state.stopFlag) throw new Error('ABORT');
                const item = currentSnapshot[idx];
                item.el.className = 'array-item color-sorted';
                moveItem(item, l + temp.length, targetDepth);
                temp.push(item);
                await waitStep(0.3);
            };

            while (i <= m) await processRemaining(i++);
            while (j <= r) await processRemaining(j++);

            removePointers();

            // æ›´æ–°ä¸»æ•°ç»„çŠ¶æ€ï¼Œç¡®ä¿åç»­é€»è¾‘å¼•ç”¨çš„ç´¢å¼•æ­£ç¡®
            for(let k=0; k<temp.length; k++) {
                state.visualItems[l + k] = temp[k];
            }
            
            // æ¢å¤è¯¥å±‚çº§é¢œè‰²ï¼ˆå¦‚æœä¸æ˜¯æœ€é¡¶å±‚ï¼‰
            if (targetDepth > 0) {
                // å¯é€‰ï¼šç¨å¾®åœç•™å±•ç¤ºåˆå¹¶ç»“æœ
                await waitStep(0.5);
            }
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---

        function moveItem(item, targetIndex, targetDepth) {
            const coords = getCoordinates(targetIndex, targetDepth);
            item.el.style.left = `${coords.left}px`;
            item.el.style.top = `${coords.top}px`;
            item.currentIdx = targetIndex;
            item.depth = targetDepth;
            
            if(targetDepth > 0) item.el.parentElement.classList.add('item-deep');
            else item.el.parentElement.classList.remove('item-deep');
        }

        function setRangeColor(start, end, className) {
            for(let i = start; i <= end; i++) {
                if(state.visualItems[i]) {
                    // æ¸…é™¤ä¹‹å‰çš„é¢œè‰²ç±»ï¼Œä¿ç•™åŸºç¡€ç±»
                    state.visualItems[i].el.className = `array-item ${className}`;
                }
            }
        }

        // æŒ‡é’ˆç®¡ç†
        function showPointers(itemL, itemR) {
            state.currentPointers = { l: itemL, r: itemR };
            els.pointerLayer.innerHTML = '';
            
            const createPtr = (type, item) => {
                const ptr = document.createElement('div');
                ptr.className = `pointer pointer-${type}`;
                ptr.innerHTML = `<div class="pointer-arrow"></div><div class="pointer-tag">${type.toUpperCase()}</div>`;
                
                const coords = getCoordinates(item.currentIdx, item.depth);
                // æŒ‡é’ˆæ˜¾ç¤ºåœ¨æ–¹å—ä¸‹æ–¹
                ptr.style.left = `${coords.left + config.blockSize/2 - 20}px`;
                ptr.style.top = `${coords.top + config.blockSize + 5}px`;
                return ptr;
            };

            els.pointerLayer.appendChild(createPtr('l', itemL));
            els.pointerLayer.appendChild(createPtr('r', itemR));
        }

        function removePointers() {
            els.pointerLayer.innerHTML = '';
            state.currentPointers = { l: null, r: null };
        }

        // æµç¨‹æ§åˆ¶
        async function waitStep(ratio = 1) {
            if (state.stopFlag) throw new Error('ABORT');
            if (state.isPaused) {
                return new Promise(resolve => { state.stepResolver = resolve; });
            }
            return new Promise(resolve => setTimeout(resolve, state.speed * ratio));
        }

        function togglePause() {
            if (!state.isSorting) return;
            state.isPaused = !state.isPaused;
            
            if (state.isPaused) {
                els.pauseBtn.innerHTML = '<i class="fas fa-play"></i> ç»§ç»­';
                updateStatus('å·²æš‚åœ', 'paused');
                log('â¸ï¸ æµç¨‹æš‚åœ');
            } else {
                els.pauseBtn.innerHTML = '<i class="fas fa-pause"></i> æš‚åœ';
                updateStatus('å½’å¹¶ä¸­', 'running');
                log('â–¶ï¸ æµç¨‹ç»§ç»­');
                if (state.stepResolver) {
                    state.stepResolver();
                    state.stepResolver = null;
                }
            }
        }

        function stepExec() {
            if (!state.isSorting) {
                state.isPaused = true;
                startSort();
                updateStatus('å•æ­¥æ¨¡å¼', 'paused');
                els.pauseBtn.innerHTML = '<i class="fas fa-play"></i> ç»§ç»­';
            } else if (state.isPaused && state.stepResolver) {
                state.stepResolver();
                state.stepResolver = null;
            }
        }

        function hardReset(newArray = false) {
            state.stopFlag = true;
            if (state.stepResolver) state.stepResolver();
            
            setTimeout(() => {
                generateArray(newArray);
            }, 100);
        }

        function finishSort() {
            state.isSorting = false;
            state.isComplete = true;
            updateStatus('å·²å®Œæˆ', 'running');
            removePointers();
            
            // æœ€ç»ˆåŠ¨ç”»
            state.visualItems.forEach(item => {
                item.el.className = 'array-item color-sorted';
                item.el.style.transform = 'scale(1.1)';
                setTimeout(() => item.el.style.transform = 'scale(1)', 300);
            });
            
            els.startBtn.disabled = false;
            els.startBtn.innerHTML = '<i class="fas fa-redo"></i> é‡æ–°å¼€å§‹';
            els.pauseBtn.disabled = true;
            els.stepBtn.disabled = true;
            log(`ğŸ† æ’åºå®Œæˆï¼å…±æ¯”è¾ƒ ${state.comparisons} æ¬¡`);
        }

        // å·¥å…·å‡½æ•°
        function updateStatus(text, type) {
            els.statusText.textContent = text;
            els.statusDot.className = `status-dot dot-${type}`;
        }

        function log(msg) {
            const div = document.createElement('div');
            div.className = 'log-entry text-slate-600 flex items-start gap-2 border-l-2 border-indigo-100 pl-2 py-1';
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            div.innerHTML = `<span class="text-xs text-indigo-400 font-mono mt-0.5">[${time}]</span> <span class="flex-1">${msg}</span>`;
            els.log.appendChild(div);
            els.log.scrollTop = els.log.scrollHeight;
        }

        function clearLog() {
            els.log.innerHTML = '';
        }
    </script>
</body>
</html>